{% extends 'base.html' %}

{% block title %}Python Online Compiler with Proctoring{% endblock %}

{% block content %}
<h1>Python Online Compiler</h1>

<!-- Mode Selection -->
<div>
    <label>Select Mode:</label>
    <select id="mode-selector" {% if selected_mode == "exam" %}disabled{% endif %}>
        <option value="lab" {% if selected_mode == "lab" or not selected_mode %}selected{% endif %}>Lab Mode</option>
        <option value="exam" {% if selected_mode == "exam" %}selected{% endif %}>Exam Mode</option>
    </select>
</div>

<!-- Hidden mode input for form submission -->
<form method="post" action="{% url 'compile' %}">
    {% csrf_token %}
    <input type="hidden" id="mode-input" name="mode" value="lab">
    <textarea name="code" rows="10" cols="50" placeholder="Write your Python code here...">{% if code %}{{ code }}{% endif %}</textarea><br>
    <button type="submit">Compile</button>
</form>

{% if output %}
    <h3>Output:</h3>
    <pre>{{ output }}</pre>
    <a href="{% url 'view_pdf' code=code|urlencode output=output|urlencode %}"><button>View as PDF</button></a>
{% endif %}

<video id="webcam" autoplay playsinline width="320" height="240" style="border: 1px solid black; display: none;"></video>
<audio id="alarm-sound" src="/static/alarm3.mp3" preload="auto"></audio>

<div id="warning-message" style="position: fixed; top: 10px; left: 10px; color: red; font-size: 18px; font-weight: bold; display: none;">
    Malpractice detected!
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/dist/face-api.min.js"></script>

<script>
    const video = document.getElementById('webcam');
    const alarmSound = document.getElementById('alarm-sound');
    const warningMessage = document.getElementById('warning-message');
    const modeSelector = document.getElementById('mode-selector');
    const modeInput = document.getElementById('mode-input');

    let mode = modeSelector.value; // Default to lab mode

    modeSelector.addEventListener('change', function () {
        mode = modeSelector.value;
        modeInput.value = mode; // Set the hidden input value

        if (mode === 'lab') {
            stopWebcam();
        } else {
            startWebcam();
            modeSelector.disabled = true; // Disable the mode selector once exam mode is selected
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        modeInput.value = modeSelector.value; // Set the initial mode for form submission
        if (mode === 'exam') {
            startWebcam();
            modeSelector.disabled = true; // Disable the mode selector if exam mode is already selected
        }
    });

    let noFaceCount = 0;
    let staticFaceCount = 0;
    let alarmTriggered = false;
    let noFaceCycleCount = 0;
    let staticMalpracticeCycleCount = 0;
    let previousDetectionBox = null;

    async function loadModels() {
        await faceapi.nets.tinyFaceDetector.loadFromUri('/static/models/');
        if (mode === 'exam') {
            startWebcam();
        }
    }

    function startWebcam() {
        video.style.display = 'block';
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                monitorFaceDetection();
            })
            .catch(error => {
                console.error('Error accessing webcam:', error);
            });
    }

    function stopWebcam() {
        video.style.display = 'none';
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        stopAlarm();
    }

    function playAlarm(message) {
        if (!alarmTriggered) {
            warningMessage.textContent = message || "Malpractice detected!";
            warningMessage.style.display = 'block';
            alarmSound.loop = true;
            alarmSound.play().catch(err => console.error('Error playing alarm sound:', err));
            alarmTriggered = true;
        }
    }

    function stopAlarm() {
        if (alarmTriggered) {
            warningMessage.style.display = 'none';
            alarmSound.pause();
            alarmSound.currentTime = 0;
            alarmTriggered = false;
        }
    }

    async function monitorFaceDetection() {
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.5 });

        setInterval(async () => {
            if (mode !== 'exam') return;

            const detections = await faceapi.detectAllFaces(video, options);

            if (detections.length > 0) {
                noFaceCount = 0;
                stopAlarm();
                const currentDetectionBox = detections[0].box;

                if (previousDetectionBox) {
                    const movementThreshold = 10;
                    const movement = Math.abs(currentDetectionBox.x - previousDetectionBox.x) +
                                     Math.abs(currentDetectionBox.y - previousDetectionBox.y);

                    if (movement < movementThreshold) {
                        staticFaceCount++;

                        if (staticFaceCount >= 10) {
                            staticMalpracticeCycleCount++;
                            playAlarm("No movement detected for 10 seconds!");

                            if (staticMalpracticeCycleCount >= 4) {
                                window.location.href = "/malpractice/";
                            }
                            staticFaceCount = 0;
                        }
                    } else {
                        staticFaceCount = 0;
                    }
                }

                previousDetectionBox = currentDetectionBox;
            } else {
                noFaceCount++;

                if (noFaceCount >= 3) {
                    playAlarm("Face not detected for 3 seconds!");
                    noFaceCycleCount++;

                    if (noFaceCycleCount >= 4) {
                        window.location.href = "/malpractice/";
                    }
                    noFaceCount = 0;
                }
            }
        }, 1000);
    }

    loadModels();
</script>
{% endblock %}
